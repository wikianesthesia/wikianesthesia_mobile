mw.loader.implement("ext.visualEditor.mwimage@i8od2",function($,jQuery,require,module){ve.dm.MWImageModel=function VeDmMWImageModel(parentDoc,config){var scalable,currentDimensions,minDimensions;config=config||{};OO.EventEmitter.call(this);this.attributesCache=null;this.parentDoc=parentDoc;this.captionDoc=null;this.caption=null;this.mediaType=null;this.altText='';this.type=null;this.alignment=null;this.scalable=null;this.sizeType=null;this.border=!1;this.borderable=!1;this.defaultDimensions=null;this.changedImageSource=!1;this.imageSrc='';this.imageResourceName='';this.imageHref='';this.boundingBox=null;this.initialHash={};this.defaultThumbSize=mw.config.get('wgVisualEditorConfig').thumbLimits[mw.user.options.get('thumbsize')];if(config.resourceName){this.setImageResourceName(config.resourceName);}currentDimensions=config.currentDimensions||{};minDimensions=config.minDimensions||{};scalable=new ve.dm.Scalable({currentDimensions:{width:currentDimensions.width,height:
currentDimensions.height},minDimensions:{width:minDimensions.width||1,height:minDimensions.height||1},defaultSize:!!config.isDefaultSize});this.attachScalable(scalable);};OO.mixinClass(ve.dm.MWImageModel,OO.EventEmitter);ve.dm.MWImageModel.static.infoCache={};ve.dm.MWImageModel.static.createImageNode=function(attributes,imageType){var attrs,newNode,newDimensions,defaultThumbSize=mw.config.get('wgVisualEditorConfig').thumbLimits[mw.user.options.get('thumbsize')];attrs=ve.extendObject({mediaClass:'Image',type:'thumb',align:'default',width:defaultThumbSize,mediaType:'BITMAP',defaultSize:!0},attributes);if(attrs.defaultSize){newDimensions=ve.dm.MWImageNode.static.scaleToThumbnailSize(attrs,attrs.mediaType);if(newDimensions){attrs.width=newDimensions.width;attrs.height=newDimensions.height;}}imageType=imageType||'mwBlockImage';newNode=ve.dm.nodeFactory.createFromElement({type:imageType,attributes:attrs});ve.dm.MWImageNode.static.syncScalableToType(attrs.type,attrs.mediaType,newNode.
getScalable());return newNode;};ve.dm.MWImageModel.static.newFromImageAttributes=function(attrs,parentDoc){var imgModel=new ve.dm.MWImageModel(parentDoc,{resourceName:attrs.resource,currentDimensions:{width:attrs.width,height:attrs.height},defaultSize:!!attrs.defaultSize});imgModel.cacheOriginalImageAttributes(attrs);imgModel.setImageSource(attrs.src);imgModel.setFilename(new mw.Title(mw.libs.ve.normalizeParsoidResourceName(attrs.resource)).getMainText());imgModel.setImageHref(attrs.href);imgModel.setBoundingBox({width:attrs.width,height:attrs.height});imgModel.toggleBorder(!!attrs.borderImage);imgModel.setAltText(attrs.alt||'');imgModel.setType(attrs.type);imgModel.setAlignment(attrs.align||'default');imgModel.toggleDefaultSize(!!attrs.defaultSize);imgModel.setSizeType(imgModel.isDefaultSize()?'default':'custom');return imgModel;};ve.dm.MWImageModel.static.newFromImageNode=function(node){return ve.dm.MWImageModel.static.newFromImageAttributes(node.getAttributes(),node.getDocument());}
;ve.dm.MWImageModel.prototype.getHashObject=function(){var hash={filename:this.getFilename(),altText:this.getAltText(),type:this.getType(),alignment:this.getAlignment(),sizeType:this.getSizeType(),border:this.hasBorder(),borderable:this.isBorderable()};if(this.getScalable()){hash.scalable={currentDimensions:ve.copy(this.getScalable().getCurrentDimensions()),isDefault:this.getScalable().isDefault()};}return hash;};ve.dm.MWImageModel.prototype.getNormalizedImageSource=function(){return this.getImageSource().replace(/^https?:\/\//,'//');};ve.dm.MWImageModel.prototype.changeImageSource=function(attrs,APIinfo){var imageModel=this;this.changedImageSource=!0;if(attrs.mediaType){this.setMediaType(attrs.mediaType);}if(attrs.href){this.setImageHref(attrs.href);}if(attrs.resource){this.setImageResourceName(attrs.resource);this.setFilename(new mw.Title(mw.libs.ve.normalizeParsoidResourceName(attrs.resource)).getMainText());}if(attrs.src){this.setImageSource(attrs.src);}this.scalable.
clearOriginalDimensions();this.scalable.clearDefaultDimensions();this.scalable.clearMaxDimensions();this.scalable.clearMinDimensions();if(APIinfo){imageModel.scalable.setOriginalDimensions({width:APIinfo.width,height:APIinfo.height});imageModel.setMediaType(APIinfo.mediatype);ve.dm.MWImageNode.static.syncScalableToType(imageModel.getType(),APIinfo.mediatype,imageModel.scalable);imageModel.updateScalableDetails({width:APIinfo.width,height:APIinfo.height});}else{if(this.getFilename()){ve.dm.MWImageNode.static.getScalablePromise(this.getFilename()).done(function(info){imageModel.scalable.setOriginalDimensions({width:info.width,height:info.height});imageModel.setMediaType(info.mediatype);ve.dm.MWImageNode.static.syncScalableToType(imageModel.getType(),info.mediatype,imageModel.scalable);imageModel.updateScalableDetails({width:info.width,height:info.height});});}else{throw new Error('Cannot compute details for an image without remote filename and without sizing info.');}}};ve.dm.
MWImageModel.prototype.getImageNodeType=function(imageType,align){imageType=imageType||this.getType();if((this.getType()==='frameless'||this.getType()==='none')&&(!this.isAligned(align)||this.isDefaultAligned(imageType,align))){return'mwInlineImage';}else{return'mwBlockImage';}};ve.dm.MWImageModel.prototype.getBoundingBox=function(){return this.boundingBox;};ve.dm.MWImageModel.prototype.updateImageNode=function(node,surfaceModel){var captionRange,captionNode,doc=surfaceModel.getDocument();if(node.getType()==='mwBlockImage'){captionNode=node.getCaptionNode();if(!captionNode){surfaceModel.getFragment().adjustLinearSelection(1).collapseToStart().insertContent([{type:'mwImageCaption'},{type:'/mwImageCaption'}]);captionNode=node.getCaptionNode();}captionRange=captionNode.getRange();surfaceModel.change(ve.dm.TransactionBuilder.static.newFromRemoval(doc,captionRange,!0));surfaceModel.change(ve.dm.TransactionBuilder.static.newFromDocumentInsertion(doc,captionRange.start,this.
getCaptionDocument()));}surfaceModel.change(ve.dm.TransactionBuilder.static.newFromAttributeChanges(doc,node.getOffset(),this.getUpdatedAttributes()));};ve.dm.MWImageModel.prototype.insertImageNode=function(fragment){var offset,contentToInsert,selectedNode,nodeType=this.getImageNodeType(),surfaceModel=fragment.getSurface();if(!(fragment.getSelection()instanceof ve.dm.LinearSelection)){return fragment;}selectedNode=fragment.getSelectedNode();if(selectedNode){fragment.removeContent();}contentToInsert=this.getData();switch(nodeType){case'mwInlineImage':if(selectedNode&&selectedNode.type==='mwBlockImage'){fragment.insertContent([{type:'paragraph',internal:{generated:'wrapper'}},{type:'/paragraph'}]);offset=fragment.getSelection().getRange().start+1;}else{offset=fragment.getDocument().data.getNearestContentOffset(fragment.getSelection().getRange().start);}if(offset>-1){fragment=fragment.clone(new ve.dm.LinearSelection(new ve.Range(offset)));}fragment.insertContent(contentToInsert);return fragment
;case'mwBlockImage':offset=fragment.getDocument().data.getNearestStructuralOffset(fragment.getSelection().getRange().start,-1);if(offset>-1){fragment=fragment.clone(new ve.dm.LinearSelection(new ve.Range(offset)));}fragment.insertContent(contentToInsert);surfaceModel.change(ve.dm.TransactionBuilder.static.newFromDocumentInsertion(surfaceModel.getDocument(),fragment.getSelection().getRange().start+2,this.getCaptionDocument()));return fragment;default:throw new Error('Unknown image node type '+nodeType);}};ve.dm.MWImageModel.prototype.getData=function(){var data,originalAttrs=ve.copy(this.getOriginalImageAttributes()),editAttributes=ve.extendObject(originalAttrs,this.getUpdatedAttributes()),nodeType=this.getImageNodeType();delete editAttributes.originalClasses;delete editAttributes.unrecognizedClasses;if(this.isChangedImageSource()){delete editAttributes.isError;}data=[{type:nodeType,attributes:editAttributes},{type:'/'+nodeType}];if(nodeType==='mwBlockImage'){data.splice(1,0,{type:
'mwImageCaption'},{type:'/mwImageCaption'});}return data;};ve.dm.MWImageModel.prototype.getUpdatedAttributes=function(){var attrs,currentDimensions,origAttrs=this.getOriginalImageAttributes();if(this.scalable.isDefault()&&this.scalable.getDefaultDimensions()){currentDimensions=this.scalable.getDefaultDimensions();}else{currentDimensions=this.getCurrentDimensions();}attrs={mediaClass:this.getMediaClass(),type:this.getType(),width:currentDimensions.width,height:currentDimensions.height,defaultSize:this.isDefaultSize(),borderImage:this.hasBorder()};if(this.getAltText()||typeof origAttrs.alt==='string'){attrs.alt=this.getAltText();}if(this.isDefaultAligned()){attrs.align='default';}else if(!this.isAligned()){attrs.align='none';}else{attrs.align=this.getAlignment();}attrs.src=this.getImageSource();attrs.href=this.getImageHref();attrs.resource=this.getImageResourceName();return attrs;};ve.dm.MWImageModel.prototype.onScalableDefaultSizeChange=function(isDefault){this.toggleDefaultSize(
isDefault);};ve.dm.MWImageModel.prototype.setImageSource=function(src){this.imageSrc=src;};ve.dm.MWImageModel.prototype.setImageResourceName=function(resourceName){this.imageResourceName=resourceName;};ve.dm.MWImageModel.prototype.setImageHref=function(href){this.imageHref=href;};ve.dm.MWImageModel.prototype.setBoundingBox=function(box){this.boundingBox=box;};ve.dm.MWImageModel.prototype.storeInitialHash=function(hash){this.initialHash=hash;};ve.dm.MWImageModel.prototype.setMediaType=function(type){this.mediaType=type;};ve.dm.MWImageModel.prototype.isDefaultSize=function(){return this.scalable.isDefault()||this.getType()==='frame';};ve.dm.MWImageModel.prototype.hasBorder=function(){return this.border;};ve.dm.MWImageModel.prototype.isChangedImageSource=function(){return this.changedImageSource;};ve.dm.MWImageModel.prototype.isAligned=function(align){align=align||this.alignment;return align&&align!=='none';};ve.dm.MWImageModel.prototype.isDefaultAligned=function(imageType,align){var
alignment=align||this.getAlignment(),defaultAlignment=(this.parentDoc.getDir()==='rtl')?'left':'right';imageType=imageType||this.getType();if(!alignment){return!0;}if(((imageType==='frameless'||imageType==='none')&&alignment==='none')||((imageType==='thumb'||imageType==='frame')&&alignment===defaultAlignment)){return!0;}return!1;};ve.dm.MWImageModel.prototype.isBorderable=function(){return this.borderable;};ve.dm.MWImageModel.prototype.getResourceName=function(){return this.imageResourceName;};ve.dm.MWImageModel.prototype.getAltText=function(){return this.altText||'';};ve.dm.MWImageModel.prototype.getType=function(){return this.type;};ve.dm.MWImageModel.prototype.getSizeType=function(){return this.sizeType;};ve.dm.MWImageModel.prototype.getMediaType=function(){return this.mediaType;};ve.dm.MWImageModel.prototype.getMediaClass=function(){var mediaType=this.getMediaType();if(mediaType==='VIDEO'){return'Video';}if(mediaType==='AUDIO'){return'Audio';}return'Image';};ve.dm.
MWImageModel.prototype.getAlignment=function(){return this.alignment;};ve.dm.MWImageModel.prototype.getVerticalAlignment=function(){return this.verticalAlignment;};ve.dm.MWImageModel.prototype.getScalable=function(){return this.scalable;};ve.dm.MWImageModel.prototype.getCurrentDimensions=function(){return this.scalable.getCurrentDimensions();};ve.dm.MWImageModel.prototype.getCaptionDocument=function(){if(!this.captionDoc){this.captionDoc=this.parentDoc.cloneWithData([{type:'paragraph',internal:{generated:'wrapper'}},{type:'/paragraph'},{type:'internalList'},{type:'/internalList'}]);}return this.captionDoc;};ve.dm.MWImageModel.prototype.toggleBorderable=function(borderable){borderable=borderable!==undefined?!!borderable:!this.isBorderable();this.borderable=borderable;};ve.dm.MWImageModel.prototype.toggleBorder=function(hasBorder){hasBorder=hasBorder!==undefined?!!hasBorder:!this.hasBorder();this.border=!!hasBorder;};ve.dm.MWImageModel.prototype.toggleDefaultSize=function(isDefault){
isDefault=isDefault!==undefined?!!isDefault:!this.isDefaultSize();if(this.isDefaultSize()!==isDefault){this.scalable.toggleDefault(!!isDefault);this.resetDefaultDimensions();this.emit('sizeDefaultChange',!!isDefault);}};ve.dm.MWImageModel.prototype.cacheOriginalImageAttributes=function(attrs){this.attributesCache=attrs;};ve.dm.MWImageModel.prototype.getOriginalImageAttributes=function(){return this.attributesCache;};ve.dm.MWImageModel.prototype.setCurrentDimensions=function(dimensions){var normalizedDimensions=ve.dm.Scalable.static.getDimensionsFromValue(dimensions,this.scalable.getRatio());this.scalable.setCurrentDimensions(normalizedDimensions);};ve.dm.MWImageModel.prototype.setAltText=function(text){this.altText=text;};ve.dm.MWImageModel.prototype.setType=function(type){var isDefaultAligned=this.isDefaultAligned(this.imageCurrentType);this.type=type;if(isDefaultAligned&&this.imageCurrentType!==this.type){if(this.type==='none'||this.type==='frameless'){this.setAlignment('none');}else
{this.setAlignment('default');}}this.imageCurrentType=type;if(type==='frame'||type==='thumb'){this.toggleBorderable(!1);}else{this.toggleBorderable(!0);}if(type==='frame'){this.toggleDefaultSize(!0);}ve.dm.MWImageNode.static.syncScalableToType(type,this.getMediaType(),this.getScalable());this.emit('typeChange',type);};ve.dm.MWImageModel.prototype.resetDefaultDimensions=function(){var originalDimensions=this.scalable.getOriginalDimensions();if(!ve.isEmptyObject(originalDimensions)){if(this.getType()==='thumb'||this.getType()==='frameless'){if(originalDimensions.width<=this.defaultThumbSize){this.scalable.setDefaultDimensions(originalDimensions);}else{this.scalable.setDefaultDimensions(ve.dm.Scalable.static.getDimensionsFromValue({width:this.defaultThumbSize},this.scalable.getRatio()));}}else{this.scalable.setDefaultDimensions(originalDimensions);}}else{this.scalable.clearDefaultDimensions();}};ve.dm.MWImageModel.prototype.getDefaultDimensions=function(){return this.scalable.
getDefaultDimensions();};ve.dm.MWImageModel.prototype.setSizeType=function(type){if(this.sizeType!==type){this.sizeType=type;this.toggleDefaultSize(type==='default');}};ve.dm.MWImageModel.prototype.setAlignment=function(align){if(align==='default'){align=this.getDefaultDir();}this.alignment=align;this.emit('alignmentChange',align);};ve.dm.MWImageModel.prototype.setVerticalAlignment=function(valign){this.verticalAlignment=valign;this.emit('alignmentChange',valign);};ve.dm.MWImageModel.prototype.getDefaultDir=function(imageNodeType){imageNodeType=imageNodeType||this.getImageNodeType();if(this.parentDoc.getDir()==='rtl'){return(imageNodeType==='mwBlockImage')?'left':'none';}else{return(imageNodeType==='mwBlockImage')?'right':'none';}};ve.dm.MWImageModel.prototype.getImageSource=function(){return this.imageSrc;};ve.dm.MWImageModel.prototype.getImageResourceName=function(){return this.imageResourceName;};ve.dm.MWImageModel.prototype.getImageHref=function(){return this.imageHref;};ve.dm.
MWImageModel.prototype.attachScalable=function(scalable){var imageName=mw.libs.ve.normalizeParsoidResourceName(this.getResourceName()),imageModel=this;if(this.scalable instanceof ve.dm.Scalable){this.scalable.disconnect(this);}this.scalable=scalable;this.scalable.connect(this,{defaultSizeChange:'onScalableDefaultSizeChange'});if(imageName){ve.dm.MWImageNode.static.getScalablePromise(imageName).done(function(info){imageModel.scalable.setOriginalDimensions({width:info.width,height:info.height});imageModel.setMediaType(info.mediatype);ve.dm.MWImageNode.static.syncScalableToType(imageModel.getType(),imageModel.getMediaType(),imageModel.getScalable());if(!ve.isEmptyObject(imageModel.initialHash)&&imageModel.initialHash.scalable.isDefault){imageModel.initialHash.scalable.currentDimensions=imageModel.scalable.getDefaultDimensions();}});}};ve.dm.MWImageModel.prototype.setFilename=function(filename){this.filename=filename;};ve.dm.MWImageModel.prototype.getFilename=function(){return this.
filename;};ve.dm.MWImageModel.prototype.updateScalableDetails=function(originalDimensions){var newDimensions;if(this.isDefaultSize()){newDimensions=ve.dm.MWImageNode.static.scaleToThumbnailSize(originalDimensions);}else{if(this.getBoundingBox()){newDimensions=ve.dm.MWImageNode.static.resizeToBoundingBox(originalDimensions,{width:this.boundingBox.width,height:Infinity});}else{newDimensions=originalDimensions;}}if(newDimensions){this.getScalable().setCurrentDimensions(newDimensions);}};ve.dm.MWImageModel.prototype.setCaptionDocument=function(doc){this.captionDoc=doc;};ve.dm.MWImageModel.prototype.hasBeenModified=function(){if(this.initialHash){return!ve.compare(this.initialHash,this.getHashObject());}return!0;};ve.ui.MWMediaInfoFieldWidget=function VeUiMWMediaInfoFieldWidget(content,config){var datetime;config=config||{};ve.ui.MWMediaInfoFieldWidget.super.call(this,config);OO.ui.mixin.IconElement.call(this,config);OO.ui.mixin.LabelElement.call(this,$.extend({$label:$('<div>')},config))
;this.$text=$('<div>').addClass('ve-ui-mwMediaInfoFieldWidget-text');this.$overlay=null;this.type=config.type||'attribute';if(config.isDate&&(datetime=moment(content)).isValid()){content=datetime.fromNow();}if(config.label){content=ve.msg(config.label,content);}if(config.href){this.$text.append($('<a>').attr('target','_blank').attr('rel','mw:ExtLink').attr('href',!config.href.match(/^(https?:)?\/\//)?'//'+config.href:config.href).append(content));}else{this.$text.append(content);}this.$element.append(this.$icon,this.$label).addClass('ve-ui-mwMediaInfoFieldWidget').addClass('ve-ui-mwMediaInfoFieldWidget-'+this.type);this.$icon.addClass('ve-ui-mwMediaInfoFieldWidget-icon');if(this.type==='description'){this.readMoreButton=new OO.ui.ButtonWidget({framed:!1,icon:'expand',label:ve.msg('visualeditor-dialog-media-info-readmore'),classes:['ve-ui-mwMediaInfoFieldWidget-readmore']});this.readMoreButton.toggle(!1);this.readMoreButton.connect(this,{click:'onReadMoreClick'});this.$text.css(
'maxHeight',config.descriptionHeight||'4em');this.$element.append(this.readMoreButton.$element);}this.setLabel(this.$text);};OO.inheritClass(ve.ui.MWMediaInfoFieldWidget,OO.ui.Widget);OO.mixinClass(ve.ui.MWMediaInfoFieldWidget,OO.ui.mixin.IconElement);OO.mixinClass(ve.ui.MWMediaInfoFieldWidget,OO.ui.mixin.LabelElement);ve.ui.MWMediaInfoFieldWidget.static.tagName='div';ve.ui.MWMediaInfoFieldWidget.static.threshold=24;ve.ui.MWMediaInfoFieldWidget.prototype.initialize=function(){var actualHeight,containerHeight;if(this.getType()==='description'){actualHeight=this.$text.prop('scrollHeight');containerHeight=this.$text.outerHeight(!0);if(actualHeight<containerHeight+this.constructor.static.threshold){this.$text.css('maxHeight','');}else{this.readMoreButton.toggle(containerHeight<actualHeight);}}};ve.ui.MWMediaInfoFieldWidget.prototype.onReadMoreClick=function(){this.readMoreButton.toggle(!1);this.$text.css('maxHeight',this.$text.prop('scrollHeight'));};ve.ui.MWMediaInfoFieldWidget.
prototype.getType=function(){return this.type;};ve.ui.MWMediaTransferHandler=function VeUiMWMediaTransferHandler(){ve.ui.MWMediaTransferHandler.super.apply(this,arguments);};OO.inheritClass(ve.ui.MWMediaTransferHandler,ve.ui.DataTransferHandler);ve.ui.MWMediaTransferHandler.static.name='media';ve.ui.MWMediaTransferHandler.static.kinds=['file'];ve.ui.MWMediaTransferHandler.static.types=['image/jpeg','image/png','image/gif','image/svg+xml'];ve.ui.MWMediaTransferHandler.static.extensions=['jpg','jpeg','png','gif','svg'];ve.ui.MWMediaTransferHandler.prototype.process=function(){var action,file=this.item.getAsFile();action=ve.ui.actionFactory.create('window',this.surface);action.open('media',{file:file});this.insertableDataDeferred.reject();};ve.ui.dataTransferHandlerFactory.register(ve.ui.MWMediaTransferHandler);ve.ui.MWMediaDialog=function VeUiMWMediaDialog(config){ve.ui.MWMediaDialog.super.call(this,config);this.imageModel=null;this.isSettingUpModel=!1;this.isInsertion=!1;this.
selectedImageInfo=null;this.searchCache={};this.$element.addClass('ve-ui-mwMediaDialog');};OO.inheritClass(ve.ui.MWMediaDialog,ve.ui.NodeDialog);ve.ui.MWMediaDialog.static.name='media';ve.ui.MWMediaDialog.static.title=OO.ui.deferMsg('visualeditor-dialog-media-title');ve.ui.MWMediaDialog.static.size='medium';ve.ui.MWMediaDialog.static.actions=[{action:'done',label:OO.ui.deferMsg('visualeditor-dialog-action-apply'),flags:['progressive','primary'],modes:'edit'},{action:'insert',label:OO.ui.deferMsg('visualeditor-dialog-action-insert'),flags:['primary','progressive'],modes:'insert'},{action:'change',label:OO.ui.deferMsg('visualeditor-dialog-media-change-image'),modes:['edit','insert']},{action:'choose',label:OO.ui.deferMsg('visualeditor-dialog-media-choose-image'),flags:['primary','progressive'],modes:['info']},{action:'upload',label:OO.ui.deferMsg('visualeditor-dialog-media-upload'),flags:['primary','progressive'],modes:['upload-upload']},{action:'save',label:OO.ui.deferMsg(
'visualeditor-dialog-media-save'),flags:['primary','progressive'],modes:['upload-info']},{action:'cancelchoose',label:OO.ui.deferMsg('visualeditor-dialog-media-goback'),flags:['safe','back'],modes:['info']},{action:'cancelupload',label:OO.ui.deferMsg('visualeditor-dialog-media-goback'),flags:['safe','back'],modes:['upload-info']},{label:OO.ui.deferMsg('visualeditor-dialog-action-cancel'),flags:['safe','close'],modes:['readonly','edit','insert','select','search','upload-upload']},{action:'back',label:OO.ui.deferMsg('visualeditor-dialog-media-goback'),flags:['safe','back'],modes:['change']}];ve.ui.MWMediaDialog.static.modelClasses=[ve.dm.MWBlockImageNode,ve.dm.MWInlineImageNode];ve.ui.MWMediaDialog.static.includeCommands=null;ve.ui.MWMediaDialog.static.excludeCommands=['paragraph','heading1','heading2','heading3','heading4','heading5','heading6','preformatted','blockquote','tableCellHeader','tableCellData','bullet','bulletWrapOnce','number','numberWrapOnce','indent','outdent'];ve.ui.
MWMediaDialog.static.getImportRules=function(){var rules=ve.copy(ve.init.target.constructor.static.importRules);return ve.extendObject(rules,{all:{blacklist:ve.extendObject({list:!0,listItem:!0,definitionList:!0,definitionListItem:!0,table:!0,tableCaption:!0,tableSection:!0,tableRow:!0,tableCell:!0,mwTable:!0,mwTransclusionTableCell:!0},ve.getProp(rules,'all','blacklist')),conversions:ve.extendObject({mwHeading:'paragraph'},ve.getProp(rules,'all','conversions'))}});};ve.ui.MWMediaDialog.prototype.getBodyHeight=function(){return 600;};ve.ui.MWMediaDialog.prototype.initialize=function(){var captionField,altTextField,altTextFieldset,positionSelectField,positionCheckboxField,positionFieldset,typeSelectField,borderField,sizeWidgetField,searchPanel,uploadPanel;ve.ui.MWMediaDialog.super.prototype.initialize.call(this);this.panels=new OO.ui.StackLayout();this.mediaSettingsLayout=new OO.ui.IndexLayout({classes:['ve-ui-mwMediaDialog-panel-settings']});this.
generalSettingsPanel=new OO.ui.TabPanelLayout('general',{label:ve.msg('visualeditor-dialog-media-page-general')});this.advancedSettingsPanel=new OO.ui.TabPanelLayout('advanced',{label:ve.msg('visualeditor-dialog-media-page-advanced')});this.filenameFieldset=new OO.ui.FieldsetLayout({label:ve.msg('visualeditor-dialog-media-content-filename'),icon:'image'});this.captionTarget=ve.init.target.createTargetWidget({includeCommands:this.constructor.static.includeCommands,excludeCommands:this.constructor.static.excludeCommands,importRules:this.constructor.static.getImportRules(),inDialog:this.constructor.static.name,multiline:!1});captionField=new OO.ui.FieldLayout(this.captionTarget,{align:'top'});this.captionFieldset=new OO.ui.FieldsetLayout({$overlay:this.$overlay,label:ve.msg('visualeditor-dialog-media-content-section'),help:ve.msg('visualeditor-dialog-media-content-section-help'),classes:['ve-ui-mwMediaDialog-caption-fieldset']});this.captionFieldset.addItems(captionField);this.
altTextInput=new OO.ui.TextInputWidget({spellcheck:!0,classes:['ve-ui-mwMediaDialog-altText']});altTextField=new OO.ui.FieldLayout(this.altTextInput,{align:'top'});altTextFieldset=new OO.ui.FieldsetLayout({$overlay:this.$overlay,label:ve.msg('visualeditor-dialog-media-alttext-section'),help:ve.msg('visualeditor-dialog-media-alttext-section-help')});altTextFieldset.addItems(altTextField);this.positionSelect=new ve.ui.AlignWidget({dir:this.getDir()});positionSelectField=new OO.ui.FieldLayout(this.positionSelect);this.positionCheckbox=new OO.ui.CheckboxInputWidget();positionCheckboxField=new OO.ui.FieldLayout(this.positionCheckbox,{$overlay:this.$overlay,align:'inline',label:ve.msg('visualeditor-dialog-media-position-checkbox'),help:ve.msg('visualeditor-dialog-media-position-checkbox-help')});positionFieldset=new OO.ui.FieldsetLayout({$overlay:this.$overlay,label:ve.msg('visualeditor-dialog-media-position-section'),help:ve.msg('visualeditor-dialog-media-position-section-help')});
positionFieldset.addItems([positionCheckboxField,positionSelectField]);this.typeSelectDropdown=new OO.ui.DropdownWidget({$overlay:this.$overlay});this.typeSelect=this.typeSelectDropdown.getMenu();this.typeSelect.addItems([new OO.ui.MenuOptionWidget({data:'thumb',icon:'imageLayoutThumbnail',label:ve.msg('visualeditor-dialog-media-type-thumb')}),new OO.ui.MenuOptionWidget({data:'frameless',icon:'imageLayoutFrameless',label:ve.msg('visualeditor-dialog-media-type-frameless')}),new OO.ui.MenuOptionWidget({data:'frame',icon:'imageLayoutFrame',label:ve.msg('visualeditor-dialog-media-type-frame')}),new OO.ui.MenuOptionWidget({data:'none',icon:'imageLayoutBasic',label:ve.msg('visualeditor-dialog-media-type-none')})]);typeSelectField=new OO.ui.FieldLayout(this.typeSelectDropdown,{align:'top'});this.borderCheckbox=new OO.ui.CheckboxInputWidget();borderField=new OO.ui.FieldLayout(this.borderCheckbox,{align:'inline',label:ve.msg('visualeditor-dialog-media-type-border')});this.typeFieldset=new OO.ui
.FieldsetLayout({$overlay:this.$overlay,label:ve.msg('visualeditor-dialog-media-type-section'),help:ve.msg('visualeditor-dialog-media-type-section-help')});this.typeFieldset.addItems([typeSelectField,borderField]);this.sizeWidget=new ve.ui.MediaSizeWidget(undefined,{dimensionsAlign:'top'});sizeWidgetField=new OO.ui.FieldLayout(this.sizeWidget);this.sizeFieldset=new OO.ui.FieldsetLayout({$overlay:this.$overlay,label:ve.msg('visualeditor-dialog-media-size-section'),help:ve.msg('visualeditor-dialog-media-size-section-help')});this.sizeFieldset.addItems([sizeWidgetField]);this.mediaSearchPanel=new OO.ui.TabPanelLayout({classes:['ve-ui-mwMediaDialog-panel-search'],scrollable:!0});if(mw.ForeignStructuredUpload&&mw.ForeignStructuredUpload.BookletLayout){this.mediaUploadBooklet=new mw.ForeignStructuredUpload.BookletLayout({$overlay:this.$overlay});}this.mediaImageInfoPanel=new OO.ui.TabPanelLayout({classes:['ve-ui-mwMediaDialog-panel-imageinfo'],scrollable:!1});this.$infoPanelWrapper=$(
'<div>').addClass('ve-ui-mwMediaDialog-panel-imageinfo-wrapper');this.searchTabs=new OO.ui.IndexLayout();searchPanel=new OO.ui.TabPanelLayout('search',{label:ve.msg('visualeditor-dialog-media-search-tab-search')});if(this.mediaUploadBooklet){uploadPanel=new OO.ui.TabPanelLayout('upload',{label:ve.msg('visualeditor-dialog-media-search-tab-upload'),content:[this.mediaUploadBooklet]});}this.search=new mw.widgets.MediaSearchWidget({rowHeight:OO.ui.isMobile()?120:200});this.positionCheckbox.connect(this,{change:'onPositionCheckboxChange'});this.borderCheckbox.connect(this,{change:'onBorderCheckboxChange'});this.positionSelect.connect(this,{choose:'onPositionSelectChoose'});this.typeSelect.connect(this,{choose:'onTypeSelectChoose'});this.search.getQuery().connect(this,{change:'onSearchQueryChange'});this.search.getQuery().$indicator.on('mousedown',this.onSearchQueryClear.bind(this));this.search.getResults().connect(this,{choose:'onSearchResultsChoose'});this.captionTarget.connect(this,{
change:'checkChanged'});this.altTextInput.connect(this,{change:'onAlternateTextChange'});this.searchTabs.connect(this,{set:'onSearchTabsSet'});if(this.mediaUploadBooklet){this.mediaUploadBooklet.connect(this,{set:'onMediaUploadBookletSet',uploadValid:'onUploadValid',infoValid:'onInfoValid'});}searchPanel.$element.append(this.search.$element);this.searchTabs.addTabPanels([searchPanel]);if(this.mediaUploadBooklet){this.searchTabs.addTabPanels([uploadPanel]);}this.mediaSearchPanel.$element.append(this.searchTabs.$element);this.generalSettingsPanel.$element.append(this.filenameFieldset.$element,this.captionFieldset.$element,altTextFieldset.$element);this.advancedSettingsPanel.$element.append(positionFieldset.$element,this.typeFieldset.$element,this.sizeFieldset.$element);this.mediaSettingsLayout.addTabPanels([this.generalSettingsPanel,this.advancedSettingsPanel]);this.panels.addItems([this.mediaSearchPanel,this.mediaImageInfoPanel,this.mediaSettingsLayout]);this.$body.append(this.panels.
$element);};ve.ui.MWMediaDialog.prototype.onSearchTabsSet=function(tabPanel){var name=tabPanel.getName();this.actions.setMode(name);switch(name){case'search':this.setSize('larger');break;case'upload':if(!this.mediaUploadBookletInit){this.mediaUploadBookletInit=!0;this.mediaUploadBooklet.initialize();}this.setSize('medium');this.uploadPageNameSet('upload');break;}};ve.ui.MWMediaDialog.prototype.onMediaUploadBookletSet=function(page){this.uploadPageNameSet(page.getName());};ve.ui.MWMediaDialog.prototype.uploadPageNameSet=function(pageName){var imageInfo;if(pageName==='insert'){imageInfo=this.mediaUploadBooklet.upload.getImageInfo();this.chooseImageInfo(imageInfo);}else{this.searchTabs.toggleMenu(pageName==='upload');this.actions.setMode('upload-'+pageName);}};ve.ui.MWMediaDialog.prototype.onUploadValid=function(isValid){this.actions.setAbilities({upload:isValid});};ve.ui.MWMediaDialog.prototype.onInfoValid=function(isValid){this.actions.setAbilities({save:isValid});};ve.ui.
MWMediaDialog.prototype.buildMediaInfoPanel=function(imageinfo){var i,newDimensions,field,isPortrait,$info,$section,windowWidth,contentDirection=this.getFragment().getDocument().getDir(),imageTitleText=imageinfo.title||imageinfo.canonicaltitle,imageTitle=new OO.ui.LabelWidget({label:mw.Title.newFromText(imageTitleText).getNameText()}),metadata=imageinfo.extmetadata,apiDataKeysConfig=[{name:'ImageDescription',value:ve.getProp(metadata,'ImageDescription','value'),data:{keepOriginal:!0},view:{type:'description',primary:!0,descriptionHeight:'5em'}},{name:'$fileDetails',data:{skipProcessing:!0},view:{icon:'image'}},{name:'LicenseShortName',value:ve.getProp(metadata,'LicenseShortName','value'),data:{},view:{href:ve.getProp(metadata,'LicenseUrl','value'),icon:this.getLicenseIcon(ve.getProp(metadata,'LicenseShortName','value'))}},{name:'Artist',value:ve.getProp(metadata,'Artist','value'),data:{},view:{label:'visualeditor-dialog-media-info-meta-artist',icon:'userAvatar'}},{name:'Credit',
value:ve.getProp(metadata,'Credit','value'),data:{},view:{icon:'userAvatar'}},{name:'user',value:imageinfo.user,data:{skipProcessing:!0},view:{icon:'userAvatar',label:'visualeditor-dialog-media-info-artist'}},{name:'timestamp',value:imageinfo.timestamp,data:{ignoreCharLimit:!0},view:{icon:'clock',label:'visualeditor-dialog-media-info-uploaded',isDate:!0}},{name:'DateTimeOriginal',value:ve.getProp(metadata,'DateTimeOriginal','value'),data:{},view:{icon:'clock',label:'visualeditor-dialog-media-info-created'}},{name:'moreinfo',value:ve.msg('visualeditor-dialog-media-info-moreinfo'),data:{},view:{icon:'info',href:imageinfo.descriptionurl}}],fields={},apiData={},fileType=this.getFileType(imageinfo.url),$thumbContainer=$('<div>').addClass('ve-ui-mwMediaDialog-panel-imageinfo-thumb'),$main=$('<div>').addClass('ve-ui-mwMediaDialog-panel-imageinfo-main'),$details=$('<div>').addClass('ve-ui-mwMediaDialog-panel-imageinfo-details'),$image=$('<img>');$main.append(imageTitle.$element.addClass(
've-ui-mwMediaDialog-panel-imageinfo-title'));for(i=0;i<apiDataKeysConfig.length;i++){field=apiDataKeysConfig[i].name;if(apiDataKeysConfig[i].data.skipProcessing){apiData[field]=apiDataKeysConfig[i].value;}else{if(apiDataKeysConfig[i].value){apiData[field]=this.cleanAPIresponse(apiDataKeysConfig[i].value,apiDataKeysConfig[i].data);}}}if(imageinfo.mediatype==='AUDIO'){apiData.$fileDetails=$('<span>').append(ve.msg('visualeditor-dialog-media-info-audiofile'));}else{apiData.$fileDetails=$('<div>').append($('<span>').text(imageinfo.width+'\u00a0'+ve.msg('visualeditor-dimensionswidget-times')+'\u00a0'+imageinfo.height+ve.msg('visualeditor-dimensionswidget-px')),$('<span>').addClass('ve-ui-mwMediaDialog-panel-imageinfo-separator').text(mw.msg('visualeditor-dialog-media-info-separator')),$('<span>').text(fileType));}for(i=0;i<apiDataKeysConfig.length;i++){field=apiDataKeysConfig[i].name;if(apiData[field]){$section=apiDataKeysConfig[i].view.primary?$main:$details;fields[field]=new ve.ui.
MWMediaInfoFieldWidget(apiData[field],apiDataKeysConfig[i].view);$section.append(fields[field].$element);}}$info=$('<div>').addClass('ve-ui-mwMediaDialog-panel-imageinfo-info').append($main.prop('dir',contentDirection),$details);ve.targetLinksToNewWindow($info[0]);$thumbContainer.append($image.prop('src',imageinfo.thumburl));this.$infoPanelWrapper.append($thumbContainer,$info);this.mediaImageInfoPanel.$element.css('overflow-y','scroll');windowWidth=this.mediaImageInfoPanel.$element.width();if(imageinfo.mediatype==='AUDIO'){newDimensions={width:imageinfo.thumbwidth,height:imageinfo.thumbwidth};}else{newDimensions=ve.dm.MWImageNode.static.resizeToBoundingBox({width:imageinfo.width,height:imageinfo.height},{width:windowWidth,height:this.getBodyHeight()-120});}$image.css({width:newDimensions.width,height:newDimensions.height});this.fetchThumbnail(imageTitleText,newDimensions).done(function(thumburl){if(thumburl){$image.prop('src',thumburl);}});isPortrait=newDimensions.width<(windowWidth*3/
5);this.mediaImageInfoPanel.$element.toggleClass('ve-ui-mwMediaDialog-panel-imageinfo-portrait',isPortrait);this.mediaImageInfoPanel.$element.append(this.$infoPanelWrapper);if(isPortrait){$info.outerWidth(Math.floor(windowWidth-$thumbContainer.outerWidth(!0)-15));}for(field in fields){fields[field].initialize();}this.mediaImageInfoPanel.$element.css('overflow','');};ve.ui.MWMediaDialog.prototype.fetchThumbnail=function(imageName,dimensions){var dialog=this,params={action:'query',prop:'imageinfo',iiprop:'url',titles:imageName};if(this.searchCache[imageName]){return ve.createDeferred().resolve(this.searchCache[imageName]);}if(dimensions.width){params.iiurlwidth=dimensions.width;}if(dimensions.height){params.iiurlheight=dimensions.height;}return ve.init.target.getContentApi(this.getFragment().getDocument()).get(params).then(function(response){var thumburl=ve.getProp(response.query.pages[0],'imageinfo',0,'thumburl');dialog.searchCache[imageName]=thumburl;return thumburl;});};ve.ui.
MWMediaDialog.prototype.cleanAPIresponse=function(rawResponse,config){var isTruncated,charLimit,html=$.parseHTML(rawResponse),ellipsis=ve.msg('visualeditor-dialog-media-info-ellipsis'),originalText=$('<div>').append(html).text();config=config||{};charLimit=config.charLimit||50;isTruncated=originalText.length>charLimit;if(config.keepOriginal){return html;}return mw.html.escape(isTruncated&&!config.ignoreCharLimit?originalText.slice(0,charLimit)+ellipsis:originalText);};ve.ui.MWMediaDialog.prototype.getFileType=function(url){return url.split('.').pop().toUpperCase();};ve.ui.MWMediaDialog.prototype.getLicenseIcon=function(license){var normalized;if(!license){return'info';}normalized=license.toLowerCase().replace(/[-_]/g,' ');if(normalized.match(/^((cc )?pd|public domain)/)){return'public-domain';}else if(normalized.match(/^cc (by|sa)?/)){return'logoCC';}else{return'info';}};ve.ui.MWMediaDialog.prototype.onSearchResultsChoose=function(item){this.chooseImageInfo(item.getData());ve.track(
'activity.'+this.constructor.static.name,{action:'search-choose-image'});};ve.ui.MWMediaDialog.prototype.onSearchQueryChange=function(query){if(query===''){return;}ve.track('activity.'+this.constructor.static.name,{action:'search-change-query'});};ve.ui.MWMediaDialog.prototype.onSearchQueryClear=function(){ve.track('activity.'+this.constructor.static.name,{action:'search-clear-query'});};ve.ui.MWMediaDialog.prototype.chooseImageInfo=function(info){this.$infoPanelWrapper.empty();this.selectedImageInfo=info;this.switchPanels('imageInfo');this.buildMediaInfoPanel(info);};ve.ui.MWMediaDialog.prototype.confirmSelectedImage=function(){var title,imageTitleText,obj={},info=this.selectedImageInfo;if(info){imageTitleText=info.title||info.canonicaltitle;title=mw.Title.newFromText(imageTitleText).getPrefixedText();if(!this.imageModel){this.imageModel=ve.dm.MWImageModel.static.newFromImageAttributes({href:'./'+title,src:info.url,resource:'./'+title,width:info.thumbwidth,height:info.thumbheight,
mediaType:info.mediatype,type:'thumb',align:'default',defaultSize:!0},this.getFragment().getDocument());this.attachImageModel();this.resetCaption();}else{this.imageModel.changeImageSource({mediaType:info.mediatype,href:'./'+title,src:info.url,resource:'./'+title},info);this.updateFilenameFieldset();}obj[imageTitleText]={size:info.size,width:info.width,height:info.height,mediatype:info.mediatype};ve.init.platform.imageInfoCache.set(obj);this.checkChanged();this.switchPanels('edit');ve.track('activity.'+this.constructor.static.name,{action:'search-confirm-image'});}};ve.ui.MWMediaDialog.prototype.updateFilenameFieldset=function(){var title=mw.Title.newFromText(mw.libs.ve.normalizeParsoidResourceName(this.imageModel.getResourceName()));this.filenameFieldset.setLabel($('<span>').append(document.createTextNode(this.imageModel.getFilename()+' '),$('<a>').addClass('ve-ui-mwMediaDialog-description-link').attr('href',title.getUrl()).attr('target','_blank').attr('rel','noopener').text(ve.msg(
'visualeditor-dialog-media-content-description-link'))));};ve.ui.MWMediaDialog.prototype.onImageModelAlignmentChange=function(alignment){alignment=alignment||'none';this.positionSelect.selectItemByData(alignment!=='none'?alignment:undefined);this.positionCheckbox.setSelected(alignment!=='none');this.checkChanged();};ve.ui.MWMediaDialog.prototype.onImageModelTypeChange=function(type){this.typeSelect.selectItemByData(type);this.borderCheckbox.setDisabled(!this.imageModel.isBorderable());this.borderCheckbox.setSelected(this.imageModel.isBorderable()&&this.imageModel.hasBorder());this.checkChanged();};ve.ui.MWMediaDialog.prototype.onPositionCheckboxChange=function(isSelected){var newPositionValue,currentModelAlignment=this.imageModel.getAlignment();this.positionSelect.setDisabled(!isSelected);this.checkChanged();if((currentModelAlignment==='none'&&isSelected)||(currentModelAlignment!=='none'&&!isSelected)){if(isSelected){newPositionValue=this.imageModel.getDefaultDir('mwBlockImage');this.
imageModel.setAlignment(newPositionValue);}else{this.imageModel.setAlignment('none');}}};ve.ui.MWMediaDialog.prototype.onBorderCheckboxChange=function(isSelected){if(this.imageModel.hasBorder()!==isSelected){this.imageModel.toggleBorder(isSelected);this.checkChanged();}};ve.ui.MWMediaDialog.prototype.onPositionSelectChoose=function(item){var position=item.getData();if(this.imageModel.getAlignment()!==position){this.imageModel.setAlignment(position);this.checkChanged();}};ve.ui.MWMediaDialog.prototype.onTypeSelectChoose=function(item){var type=item.getData();if(this.imageModel.getType()!==type){this.imageModel.setType(type);this.checkChanged();}if(type==='frame'){this.sizeWidget.setSizeType('default');}};ve.ui.MWMediaDialog.prototype.onChangeSizeType=function(sizeType){if(sizeType==='custom'&&this.imageModel.getType()==='frame'){this.imageModel.setType('thumb');}this.checkChanged();};ve.ui.MWMediaDialog.prototype.onAlternateTextChange=function(text){this.imageModel.setAltText(text);this
.checkChanged();};ve.ui.MWMediaDialog.prototype.checkChanged=function(){var captionChanged=!1;if(!this.isSettingUpModel){captionChanged=!!this.captionTarget&&this.captionTarget.hasBeenModified();if(this.imageModel&&this.sizeWidget.isValid()&&(this.isInsertion||captionChanged||this.imageModel.hasBeenModified())){this.actions.setAbilities({insert:!0,done:!0});}else{this.actions.setAbilities({insert:!1,done:!1});}}};ve.ui.MWMediaDialog.prototype.getSetupProcess=function(data){return ve.ui.MWMediaDialog.super.prototype.getSetupProcess.call(this,data).next(function(){var isReadOnly=this.isReadOnly();this.search.setLang(this.getFragment().getDocument().getLang());if(this.selectedNode){this.isInsertion=!1;this.imageModel=ve.dm.MWImageModel.static.newFromImageNode(this.selectedNode);this.attachImageModel();if(!this.imageModel.isDefaultSize()){this.imageModel.setBoundingBox(this.imageModel.getCurrentDimensions());}this.imageModel.storeInitialHash(this.imageModel.getHashObject())
;}else{this.isInsertion=!0;}this.search.setup();this.search.queryMediaQueue();this.resetCaption();this.altTextInput.setReadOnly(isReadOnly);this.positionCheckbox.setDisabled(isReadOnly);this.positionSelect.setDisabled(isReadOnly);this.typeSelectDropdown.setDisabled(isReadOnly);this.borderCheckbox.setDisabled(isReadOnly);this.sizeWidget.setDisabled(isReadOnly);this.switchPanels(this.selectedNode?'edit':'search',!0);this.actions.setAbilities({upload:!1,save:!1,insert:!1,done:!1});this.mediaUploadBookletInit=!1;if(data.file&&this.mediaUploadBooklet){this.searchTabs.setTabPanel('upload');this.mediaUploadBooklet.setFile(data.file);}},this);};ve.ui.MWMediaDialog.prototype.switchPanels=function(panel,noFocus){switch(panel){case'edit':this.setSize(this.constructor.static.size);this.panels.setItem(this.mediaSettingsLayout);this.mediaSettingsLayout.setTabPanel('general');this.actions.setMode(this.getMode());if(!noFocus){this.captionTarget.focus();}break;case'search':this.
setSize('larger');this.selectedImageInfo=null;this.panels.setItem(this.mediaSearchPanel);this.searchTabs.setTabPanel('search');this.searchTabs.toggleMenu(!0);this.actions.setMode(this.imageModel?'change':'select');if(!noFocus){this.search.getQuery().focus().select();}this.search.runLayoutQueue();break;default:case'imageInfo':this.setSize('larger');this.actions.setMode('info');this.panels.setItem(this.mediaImageInfoPanel);break;}this.currentPanel=panel||'imageinfo';};ve.ui.MWMediaDialog.prototype.attachImageModel=function(){if(this.imageModel){this.imageModel.disconnect(this);this.sizeWidget.disconnect(this);}this.imageModel.connect(this,{alignmentChange:'onImageModelAlignmentChange',typeChange:'onImageModelTypeChange',sizeDefaultChange:'checkChanged'});this.isSettingUpModel=!0;this.updateFilenameFieldset();this.sizeWidget.setScalable(this.imageModel.getScalable());this.sizeWidget.connect(this,{changeSizeType:'onChangeSizeType',change:'checkChanged',valid:'checkChanged'});this.
sizeWidget.setSizeType(this.imageModel.isDefaultSize()?'default':'custom');this.sizeWidget.updateDefaultDimensions();this.altTextInput.setValue(this.imageModel.getAltText());this.positionSelect.setDisabled(!this.imageModel.isAligned());this.positionSelect.selectItemByData(this.imageModel.isAligned()&&this.imageModel.getAlignment());this.positionCheckbox.setSelected(this.imageModel.isAligned());this.borderCheckbox.setDisabled(!this.imageModel.isBorderable());this.borderCheckbox.setSelected(this.imageModel.isBorderable()&&this.imageModel.hasBorder());this.typeSelect.selectItemByData(this.imageModel.getType()||'none');this.isSettingUpModel=!1;};ve.ui.MWMediaDialog.prototype.resetCaption=function(){var captionNode,captionDocument,doc=this.getFragment().getDocument();if(this.imageModel&&this.selectedNode&&this.selectedNode.getDocument()&&this.selectedNode instanceof ve.dm.MWBlockImageNode){captionNode=this.selectedNode.getCaptionNode();if(captionNode&&captionNode.getLength()>0){this.
imageModel.setCaptionDocument(this.selectedNode.getDocument().cloneFromRange(captionNode.getRange()));}}if(this.imageModel){captionDocument=this.imageModel.getCaptionDocument();}else{captionDocument=doc.cloneWithData([{type:'paragraph',internal:{generated:'wrapper'}},{type:'/paragraph'},{type:'internalList'},{type:'/internalList'}]);}this.captionTarget.setDocument(captionDocument);this.captionTarget.setReadOnly(this.isReadOnly());};ve.ui.MWMediaDialog.prototype.getReadyProcess=function(data){return ve.ui.MWMediaDialog.super.prototype.getReadyProcess.call(this,data).next(function(){if(!data.file){this.switchPanels(this.selectedNode?'edit':'search');}this.sizeWidget.validateDimensions();},this);};ve.ui.MWMediaDialog.prototype.getTeardownProcess=function(data){return ve.ui.MWMediaDialog.super.prototype.getTeardownProcess.call(this,data).first(function(){this.mediaSettingsLayout.resetScroll();this.search.getQuery().setValue('');this.search.teardown();if(this.imageModel){this.imageModel.
disconnect(this);this.sizeWidget.disconnect(this);}this.captionTarget.clear();this.imageModel=null;},this);};ve.ui.MWMediaDialog.prototype.getActionProcess=function(action){var handler;switch(action){case'change':handler=function(){this.switchPanels('search');};ve.track('activity.'+this.constructor.static.name,{action:'search-change-image'});break;case'back':handler=function(){this.switchPanels('edit');};break;case'choose':handler=function(){this.confirmSelectedImage();this.switchPanels('edit');};break;case'cancelchoose':handler=function(){this.switchPanels('search');if(this.mediaUploadBooklet){return this.mediaUploadBooklet.initialize();}};ve.track('activity.'+this.constructor.static.name,{action:'search-change-image'});break;case'cancelupload':handler=function(){this.searchTabs.setTabPanel('upload');this.searchTabs.toggleMenu(!0);return this.mediaUploadBooklet.initialize();};break;case'upload':ve.track('activity.'+this.constructor.static.name,{action:'search-upload-image'});return new
OO.ui.Process(this.mediaUploadBooklet.uploadFile());case'save':return new OO.ui.Process(this.mediaUploadBooklet.saveFile());case'done':case'insert':handler=function(){var surfaceModel=this.getFragment().getSurface();this.imageModel.setAltText(this.altTextInput.getValue());this.imageModel.setCaptionDocument(this.captionTarget.getSurface().getModel().getDocument());if(this.selectedNode&&this.selectedNode.type===this.imageModel.getImageNodeType()&&this.selectedNode.getAttribute('src')===this.imageModel.getImageSource()){this.imageModel.updateImageNode(this.selectedNode,surfaceModel);}else{this.fragment=this.imageModel.insertImageNode(this.getFragment());}this.close({action:action});};break;default:return ve.ui.MWMediaDialog.super.prototype.getActionProcess.call(this,action);}return new OO.ui.Process(handler,this);};ve.ui.windowFactory.register(ve.ui.MWMediaDialog);ve.ui.MWMediaDialogTool=function VeUiMWMediaDialogTool(){ve.ui.MWMediaDialogTool.super.apply(this,arguments);};OO.inheritClass
(ve.ui.MWMediaDialogTool,ve.ui.FragmentWindowTool);ve.ui.MWMediaDialogTool.static.name='media';ve.ui.MWMediaDialogTool.static.group='object';ve.ui.MWMediaDialogTool.static.icon='image';ve.ui.MWMediaDialogTool.static.title=OO.ui.deferMsg('visualeditor-dialogbutton-media-tooltip');ve.ui.MWMediaDialogTool.static.modelClasses=[ve.dm.MWBlockImageNode,ve.dm.MWInlineImageNode];ve.ui.MWMediaDialogTool.static.commandName='media';ve.ui.MWMediaDialogTool.static.autoAddToCatchall=!1;ve.ui.MWMediaDialogTool.static.autoAddToGroup=!1;ve.ui.toolFactory.register(ve.ui.MWMediaDialogTool);ve.ui.commandRegistry.register(new ve.ui.Command('media','window','open',{args:['media'],supportedSelections:['linear']}));ve.ui.MWMediaContextItem=function VeUiMWMediaContextItem(context,model){var mediaClass;ve.ui.MWMediaContextItem.super.apply(this,arguments);this.$element.addClass('ve-ui-mwMediaContextItem');mediaClass=model.getAttribute('mediaClass')||'Image';this.setIcon(model.getAttribute('isError')?
'imageBroken':{Image:'image',Audio:'play',Video:'play'}[mediaClass]);this.setLabel(ve.msg('visualeditor-media-title-'+mediaClass.toLowerCase()));};OO.inheritClass(ve.ui.MWMediaContextItem,ve.ui.LinearContextItem);ve.ui.MWMediaContextItem.static.name='mwMedia';ve.ui.MWMediaContextItem.static.icon='image';ve.ui.MWMediaContextItem.static.label=OO.ui.deferMsg('visualeditor-media-title-image');ve.ui.MWMediaContextItem.static.modelClasses=[ve.dm.MWBlockImageNode,ve.dm.MWInlineImageNode];ve.ui.MWMediaContextItem.static.commandName='media';ve.ui.MWMediaContextItem.prototype.getDescription=function(){return ve.ce.nodeFactory.getDescription(this.model);};ve.ui.MWMediaContextItem.prototype.renderBody=function(){var title=mw.Title.newFromText(mw.libs.ve.normalizeParsoidResourceName(this.model.getAttribute('resource')));this.$body.append($('<a>').text(this.getDescription()).attr({href:title.getUrl(),target:'_blank',rel:'noopener'}));};ve.ui.contextItemFactory.register(ve.ui.MWMediaContextItem);},{
"css":[
".ve-ui-mwMediaDialog-panel-imageinfo{padding-top:2em;padding-left:2em;padding-right:2em}.ve-ui-mwMediaDialog-panel-imageinfo-thumb{text-align:center}.ve-ui-mwMediaDialog-panel-imageinfo-loadingthumb img{opacity:0.8}.ve-ui-mwMediaDialog-panel-imageinfo-info{padding:1em 2em}@media (max-width:400px){.ve-ui-mwMediaDialog-panel-imageinfo-info{padding:1em 0}}.ve-ui-mwMediaDialog-panel-imageinfo-main{margin-bottom:1em}.ve-ui-mwMediaDialog-panel-imageinfo-portrait .ve-ui-mwMediaDialog-panel-imageinfo-thumb img{margin-bottom:1em;max-height:none}.ve-ui-mwMediaDialog-panel-imageinfo-portrait .ve-ui-mwMediaDialog-panel-imageinfo-thumb,.ve-ui-mwMediaDialog-panel-imageinfo-portrait .ve-ui-mwMediaDialog-panel-imageinfo-info{float:left}.ve-ui-mwMediaDialog-panel-imageinfo-portrait .ve-ui-mwMediaDialog-panel-imageinfo-info{padding-left:2em;box-sizing:border-box}.ve-ui-mwMediaDialog-panel-imageinfo-title{font-size:1.5em;line-height:1.5em;margin-top:-0.2em;margin-bottom:0.5em}.ve-ui-mwMediaDialog-panel-imageinfo-details{color:#54595d}.ve-ui-mwMediaDialog-panel-imageinfo-separator{margin:0 0.5em;display:inline-block}.ve-ui-mwMediaDialog-altText{width:auto}.mw-widget-mediaSearchWidget .oo-ui-searchWidget-results{padding-right:0} .ve-ui-mwMediaDialog-caption-fieldset.oo-ui-labelElement.oo-ui-fieldsetLayout{margin-top:0}.ve-ui-mwMediaDialog-description-link{font-size:75%} .ve-ui-mwMediaInfoFieldWidget{position:relative}.ve-ui-mwMediaInfoFieldWidget.oo-ui-iconElement .ve-ui-mwMediaInfoFieldWidget-icon{margin:0.05em;position:absolute;top:auto;opacity:0.5}.ve-ui-mwMediaInfoFieldWidget-text{word-break:break-word;word-wrap:break-word;overflow-wrap:break-word;overflow:hidden;-webkit-transition:max-height 0.5s ease-in;-moz-transition:max-height 0.5s ease-in;transition:max-height 0.5s ease-in}.ve-ui-mwMediaInfoFieldWidget-readmore{height:2em;width:100%;padding-top:1em;margin-top:-2em;background:-webkit-linear-gradient(top,rgba(255,255,255,0) 0,#fff 50%);background:linear-gradient(to bottom,rgba(255,255,255,0) 0,#fff 50%)}.ve-ui-mwMediaInfoFieldWidget.oo-ui-iconElement .oo-ui-labelElement-label{display:block;padding:0.3em 0 0.1em 2.2em;line-height:1.25em}.ve-ui-mwMediaInfoFieldWidget-description{display:block;line-height:1.25em;overflow-y:hidden}"
]},{"visualeditor-dialog-media-alttext-section":"Alternative text","visualeditor-dialog-media-alttext-section-help":"You can use this to write a text description for people who can't see the item. The description should be enough for them to understand the purpose and information given by the media item. This is vital for blind users and other people using screen-reader software or text-only browsers.","visualeditor-dialog-media-change-image":"Change image","visualeditor-dialog-media-choose-image":"Use this image","visualeditor-dialog-media-content-description-link":"(description page)","visualeditor-dialog-media-content-filename":"File name","visualeditor-dialog-media-content-section":"Caption","visualeditor-dialog-media-content-section-help":"You can use this to show a label that shows next to the item for all readers. This is often used to explain why the item is relevant to the context in which it is shown. It should be succinct and informative.","visualeditor-dialog-media-goback":
"Back","visualeditor-dialog-media-info-artist":"Uploaded by $1","visualeditor-dialog-media-info-audiofile":"Audio file","visualeditor-dialog-media-info-created":"Created: $1","visualeditor-dialog-media-info-credit":"Credit","visualeditor-dialog-media-info-dateformat":"$1 $2, $3","visualeditor-dialog-media-info-ellipsis":"","visualeditor-dialog-media-info-imagedescription":"Full description","visualeditor-dialog-media-info-licenseshortname":"License","visualeditor-dialog-media-info-meta-artist":"Artist: $1","visualeditor-dialog-media-info-moreinfo":"More information","visualeditor-dialog-media-info-readmore":"Read more","visualeditor-dialog-media-info-separator":"","visualeditor-dialog-media-info-uploaded":"Uploaded: $1","visualeditor-dialog-media-page-advanced":"Advanced","visualeditor-dialog-media-page-general":"General","visualeditor-dialog-media-position-center":"Center","visualeditor-dialog-media-position-checkbox":"Wrap text around this item",
"visualeditor-dialog-media-position-checkbox-help":"You can make this media item appear inline with the text of the page instead of floating. You should only do this rarely, as it will break up the flow of the text if you uncheck this box.","visualeditor-dialog-media-position-left":"Left","visualeditor-dialog-media-position-none":"None","visualeditor-dialog-media-position-right":"Right","visualeditor-dialog-media-position-section":"Position","visualeditor-dialog-media-position-section-help":"You can set where this media item appears on the page. This is sometimes used to break up a long line of images on one side of the page.","visualeditor-dialog-media-save":"Save","visualeditor-dialog-media-search-tab-search":"Search","visualeditor-dialog-media-search-tab-upload":"Upload","visualeditor-dialog-media-searchselect":"Select","visualeditor-dialog-media-size-section":"Image size","visualeditor-dialog-media-size-section-help":
"You can set how large the media item appears on the page. This should almost always be the normal size, as a custom size will interfere with the layout of the page for readers and make it inconsistent.","visualeditor-dialog-media-thumbdimensions":"Thumbnail dimensions","visualeditor-dialog-media-title":"Media settings","visualeditor-dialog-media-type-border":"Border","visualeditor-dialog-media-type-frame":"Frame","visualeditor-dialog-media-type-frameless":"Frameless","visualeditor-dialog-media-type-none":"Basic","visualeditor-dialog-media-type-section":"Image type","visualeditor-dialog-media-type-section-help":"You can set how the media item appears on the page. This should be the thumbnail format to be consistent with other pages in almost all cases.","visualeditor-dialog-media-type-thumb":"Thumbnail","visualeditor-dialog-media-upload":"Upload","visualeditor-dialogbutton-media-tooltip":"Images and media","visualeditor-media-title-audio":"Audio","visualeditor-media-title-image":
"Image","visualeditor-media-title-video":"Video"});mw.loader.implement("ext.visualEditor.mwimage.core@tlvwo",function($,jQuery,require,module){ve.dm.MWImageNode=function VeDmMWImageNode(){ve.dm.GeneratedContentNode.call(this);ve.dm.FocusableNode.call(this);ve.dm.ResizableNode.call(this);this.scalablePromise=null;this.mediaType='BITMAP';this.constructor.static.syncScalableToType(this.getAttribute('type'),this.mediaType,this.getScalable());this.connect(this,{attributeChange:'onAttributeChange'});};OO.inheritClass(ve.dm.MWImageNode,ve.dm.GeneratedContentNode);OO.mixinClass(ve.dm.MWImageNode,ve.dm.FocusableNode);OO.mixinClass(ve.dm.MWImageNode,ve.dm.ResizableNode);ve.dm.MWImageNode.static.rdfaToTypes=(function(){var rdfaToType={};['Image','Video','Audio'].forEach(function(mediaClass){rdfaToType['mw:'+mediaClass]={mediaClass:mediaClass,frameType:'none'};rdfaToType['mw:'+mediaClass+'/Frameless']={mediaClass:mediaClass,frameType:'frameless'};rdfaToType['mw:'+mediaClass+'/Thumb']={mediaClass:mediaClass,frameType:'thumb'};rdfaToType['mw:'+
mediaClass+'/Frame']={mediaClass:mediaClass,frameType:'frame'};});return rdfaToType;}());ve.dm.MWImageNode.static.getRdfa=function(mediaClass,frameType,isError){return(isError?'mw:Error ':'')+'mw:'+mediaClass+{none:'',frameless:'/Frameless',thumb:'/Thumb',frame:'/Frame'}[frameType];};ve.dm.MWImageNode.static.typesToTags={Image:'img',Audio:'audio',Video:'video'};ve.dm.MWImageNode.static.typesToSrcAttrs={Image:'src',Audio:null,Video:'poster'};ve.dm.MWImageNode.static.getHashObjectForRendering=function(dataElement){return{type:'mwImage',resource:dataElement.attributes.resource,width:dataElement.attributes.width,height:dataElement.attributes.height};};ve.dm.MWImageNode.static.getMatchRdfaTypes=function(){return Object.keys(this.rdfaToTypes);};ve.dm.MWImageNode.static.allowedRdfaTypes=['mw:Error'];ve.dm.MWImageNode.static.isDiffComparable=function(element,other){return element.type===other.type&&element.attributes.resource===other.attributes.resource;};ve.dm.MWImageNode.static.
describeChanges=function(attributeChanges,attributes){var key,sizeFrom,sizeTo,change,customKeys=['width','height','defaultSize','src','href'],descriptions=[];function describeSize(width,height){return width+ve.msg('visualeditor-dimensionswidget-times')+height+ve.msg('visualeditor-dimensionswidget-px');}if('width'in attributeChanges||'height'in attributeChanges){if(attributeChanges.defaultSize&&attributeChanges.defaultSize.from===!0){sizeFrom=ve.msg('visualeditor-mediasizewidget-sizeoptions-default');}else{sizeFrom=describeSize('width'in attributeChanges?attributeChanges.width.from:attributes.width,'height'in attributeChanges?attributeChanges.height.from:attributes.height);}if(attributeChanges.defaultSize&&attributeChanges.defaultSize.to===!0){sizeTo=ve.msg('visualeditor-mediasizewidget-sizeoptions-default');}else{sizeTo=describeSize('width'in attributeChanges?attributeChanges.width.to:attributes.width,'height'in attributeChanges?attributeChanges.height.to:attributes.height);}
descriptions.push(ve.htmlMsg('visualeditor-changedesc-image-size',this.wrapText('del',sizeFrom),this.wrapText('ins',sizeTo)));}for(key in attributeChanges){if(customKeys.indexOf(key)===-1){if(key==='borderImage'&&!attributeChanges.borderImage.from&&!attributeChanges.borderImage.to){continue;}change=this.describeChange(key,attributeChanges[key]);descriptions.push(change);}}return descriptions;};ve.dm.MWImageNode.static.describeChange=function(key,change){switch(key){case'align':return ve.htmlMsg('visualeditor-changedesc-align',this.wrapText('del',ve.msg('visualeditor-align-desc-'+change.from)),this.wrapText('ins',ve.msg('visualeditor-align-desc-'+change.to)));case'originalClasses':case'unrecognizedClasses':return;}return ve.dm.Node.static.describeChange.apply(this,arguments);};ve.dm.MWImageNode.static.scaleToThumbnailSize=function(dimensions,mediaType){var defaultThumbSize=mw.config.get('wgVisualEditorConfig').thumbLimits[mw.user.options.get('thumbsize')];mediaType=mediaType||'BITMAP';
if(dimensions.width&&dimensions.height){if(dimensions.width>defaultThumbSize||mediaType==='DRAWING'){return ve.dm.Scalable.static.getDimensionsFromValue({width:defaultThumbSize},dimensions.width/dimensions.height);}}return dimensions;};ve.dm.MWImageNode.static.resizeToBoundingBox=function(imageDimensions,boundingBox){var newDimensions=ve.copy(imageDimensions),scale=Math.min(boundingBox.height/imageDimensions.height,boundingBox.width/imageDimensions.width);if(scale<1){newDimensions={width:Math.floor(newDimensions.width*scale),height:Math.floor(newDimensions.height*scale)};}return newDimensions;};ve.dm.MWImageNode.static.syncScalableToType=function(type,mediaType,scalable){var originalDimensions,dimensions,defaultThumbSize=mw.config.get('wgVisualEditorConfig').thumbLimits[mw.user.options.get('thumbsize')];originalDimensions=scalable.getOriginalDimensions();if(originalDimensions){if(type==='thumb'||type==='frameless'){if(originalDimensions.width>=defaultThumbSize||mediaType==='DRAWING'){
dimensions=ve.dm.Scalable.static.getDimensionsFromValue({width:defaultThumbSize},scalable.getRatio());}else{dimensions=ve.dm.Scalable.static.getDimensionsFromValue(originalDimensions,scalable.getRatio());}scalable.setDefaultDimensions(dimensions);}else{scalable.setDefaultDimensions(originalDimensions);}}if(mediaType==='DRAWING'){scalable.setEnforcedMax(!1);}else if(mediaType==='AUDIO'){scalable.fixedRatio=!1;scalable.setMinDimensions({width:1,height:32});scalable.setMaxDimensions({width:99999,height:32});scalable.setEnforcedMax(!0);scalable.setEnforcedMin(!0);scalable.setDefaultDimensions({width:defaultThumbSize,height:32});}else{if(originalDimensions){scalable.setMaxDimensions(originalDimensions);scalable.setEnforcedMax(!0);}else{scalable.setEnforcedMax(!1);}}};ve.dm.MWImageNode.static.getScalablePromise=function(filename){if(ve.init.platform.imageInfoCache){return ve.init.platform.imageInfoCache.get(filename).then(function(info){if(!info||info.missing){return ve.
createDeferred().reject().promise();}return info;});}else{return ve.createDeferred().reject().promise();}};ve.dm.MWImageNode.prototype.onAttributeChange=function(key,from,to){if(key==='type'){this.constructor.static.syncScalableToType(to,this.mediaType,this.getScalable());}};ve.dm.MWImageNode.prototype.getFilename=function(){return mw.libs.ve.normalizeParsoidResourceName(this.getAttribute('resource')||'');};ve.dm.MWImageNode.prototype.getScalable=function(){var oldMediaType,imageNode=this;if(!this.scalablePromise){this.scalablePromise=ve.dm.MWImageNode.static.getScalablePromise(this.getFilename());this.scalablePromise.done(function(info){if(info){imageNode.getScalable().setOriginalDimensions({width:info.width,height:info.height});oldMediaType=imageNode.mediaType;imageNode.mediaType=info.mediatype;imageNode.constructor.static.syncScalableToType(imageNode.getAttribute('type'),imageNode.mediaType,imageNode.getScalable());imageNode.emit('attributeChange','mediaType',oldMediaType,imageNode.
mediaType);}});}return ve.dm.ResizableNode.prototype.getScalable.call(this);};ve.dm.MWImageNode.prototype.createScalable=function(){return new ve.dm.Scalable({currentDimensions:{width:this.getAttribute('width'),height:this.getAttribute('height')},minDimensions:{width:1,height:1}});};ve.dm.MWImageNode.prototype.getMediaType=function(){return this.mediaType;};ve.dm.MWImageNode.prototype.getRdfa=function(){return this.constructor.static.getRdfa(this.getAttribute('mediaClass'),this.getAttribute('type'),this.getAttribute('isError'));};ve.dm.MWInlineImageNode=function VeDmMWInlineImageNode(){ve.dm.MWInlineImageNode.super.apply(this,arguments);ve.dm.MWImageNode.call(this);};OO.inheritClass(ve.dm.MWInlineImageNode,ve.dm.LeafNode);OO.mixinClass(ve.dm.MWInlineImageNode,ve.dm.GeneratedContentNode);OO.mixinClass(ve.dm.MWInlineImageNode,ve.dm.MWImageNode);ve.dm.MWInlineImageNode.static.isContent=!0;ve.dm.MWInlineImageNode.static.name='mwInlineImage';ve.dm.MWInlineImageNode.static.
preserveHtmlAttributes=function(attribute){var attributes=['typeof','class','src','resource','width','height','href','data-mw'];return attributes.indexOf(attribute)===-1;};ve.dm.MWInlineImageNode.static.matchTagNames=['span','figure-inline'];ve.dm.MWInlineImageNode.static.disallowedAnnotationTypes=['link'];ve.dm.MWInlineImageNode.static.toDataElement=function(domElements,converter){var dataElement,attributes,href,targetData,container,imgWrapper,img,typeofAttrs,classes,recognizedClasses,errorIndex,width,height,types,mwDataJSON,mwData;container=domElements[0];imgWrapper=container.children[0];if(!imgWrapper){return null;}img=imgWrapper.children[0];typeofAttrs=(container.getAttribute('typeof')||'').trim().split(/\s+/);mwDataJSON=container.getAttribute('data-mw');mwData=mwDataJSON?JSON.parse(mwDataJSON):{};classes=container.getAttribute('class');recognizedClasses=[];errorIndex=typeofAttrs.indexOf('mw:Error');width=img.getAttribute('width');height=img.getAttribute('height');href=imgWrapper.
getAttribute('href');if(href){targetData=mw.libs.ve.getTargetDataFromHref(href,converter.getTargetHtmlDocument());if(targetData.isInternal){href='./'+targetData.rawTitle;}}if(errorIndex!==-1){typeofAttrs.splice(errorIndex,1);}types=this.rdfaToTypes[typeofAttrs[0]];attributes={mediaClass:types.mediaClass,type:types.frameType,src:img.getAttribute('src')||img.getAttribute('poster'),href:href,resource:img.getAttribute('resource'),originalClasses:classes,width:width!==null&&width!==''?+width:null,height:height!==null&&height!==''?+height:null,alt:img.getAttribute('alt'),mw:mwData,isError:errorIndex!==-1,tagName:container.nodeName.toLowerCase()};classes=typeof classes==='string'?classes.trim().split(/\s+/):[];if(classes.indexOf('mw-image-border')!==-1){attributes.borderImage=!0;recognizedClasses.push('mw-image-border');}attributes.valign='default';['midde','baseline','sub','super','top','text-top','bottom','text-bottom'].some(function(valign){var className='mw-valign-'+valign;if(classes.
indexOf(className)!==-1){attributes.valign=valign;recognizedClasses.push(className);return!0;}return!1;});if(classes.indexOf('mw-image-border')!==-1){attributes.borderImage=!0;recognizedClasses.push('mw-image-border');}if(classes.indexOf('mw-default-size')!==-1){attributes.defaultSize=!0;recognizedClasses.push('mw-default-size');}attributes.unrecognizedClasses=OO.simpleArrayDifference(classes,recognizedClasses);dataElement={type:this.name,attributes:attributes};this.storeGeneratedContents(dataElement,dataElement.attributes.src,converter.getStore());return dataElement;};ve.dm.MWInlineImageNode.static.toDomElements=function(data,doc){var firstChild,srcAttr,mediaClass=data.attributes.mediaClass,container=doc.createElement(data.attributes.tagName||'span'),img=doc.createElement(data.attributes.isError?'span':this.typesToTags[mediaClass]),classes=[],originalClasses=data.attributes.originalClasses;ve.setDomAttributes(img,data.attributes,['width','height','resource']);srcAttr=this.
typesToSrcAttrs[mediaClass];if(srcAttr&&!data.attributes.isError){img.setAttribute(srcAttr,data.attributes.src);}if(typeof data.attributes.alt==='string'){img.setAttribute('alt',data.attributes.alt);}container.setAttribute('typeof',this.getRdfa(mediaClass,data.attributes.type));if(!ve.isEmptyObject(data.attributes.mw)){container.setAttribute('data-mw',JSON.stringify(data.attributes.mw));}if(data.attributes.defaultSize){classes.push('mw-default-size');}if(data.attributes.borderImage){classes.push('mw-image-border');}if(data.attributes.valign&&data.attributes.valign!=='default'){classes.push('mw-valign-'+data.attributes.valign);}if(data.attributes.unrecognizedClasses){classes=OO.simpleArrayUnion(classes,data.attributes.unrecognizedClasses);}if(originalClasses&&ve.compare(originalClasses.trim().split(/\s+/).sort(),classes.sort())){container.className=originalClasses;}else if(classes.length>0){container.className=classes.join(' ');}if(data.attributes.href){firstChild=doc.createElement('a')
;firstChild.setAttribute('href',data.attributes.href);}else{firstChild=doc.createElement('span');}container.appendChild(firstChild);firstChild.appendChild(img);return[container];};ve.dm.modelRegistry.unregister(ve.dm.InlineImageNode);ve.dm.modelRegistry.register(ve.dm.MWInlineImageNode);ve.dm.MWBlockImageNode=function VeDmMWBlockImageNode(){ve.dm.MWBlockImageNode.super.apply(this,arguments);ve.dm.MWImageNode.call(this);ve.dm.ClassAttributeNode.call(this);};OO.inheritClass(ve.dm.MWBlockImageNode,ve.dm.BranchNode);OO.mixinClass(ve.dm.MWBlockImageNode,ve.dm.GeneratedContentNode);OO.mixinClass(ve.dm.MWBlockImageNode,ve.dm.MWImageNode);OO.mixinClass(ve.dm.MWBlockImageNode,ve.dm.ClassAttributeNode);ve.dm.MWBlockImageNode.static.name='mwBlockImage';ve.dm.MWBlockImageNode.static.preserveHtmlAttributes=function(attribute){var attributes=['typeof','class','src','resource','width','height','href','rel','data-mw'];return attributes.indexOf(attribute)===-1;};ve.dm.MWBlockImageNode.static.
handlesOwnChildren=!0;ve.dm.MWBlockImageNode.static.ignoreChildren=!0;ve.dm.MWBlockImageNode.static.childNodeTypes=['mwImageCaption'];ve.dm.MWBlockImageNode.static.matchTagNames=['figure'];ve.dm.MWBlockImageNode.static.disallowedAnnotationTypes=['link'];ve.dm.MWBlockImageNode.static.classAttributes={'mw-image-border':{borderImage:!0},'mw-halign-left':{align:'left'},'mw-halign-right':{align:'right'},'mw-halign-center':{align:'center'},'mw-halign-none':{align:'none'},'mw-default-size':{defaultSize:!0}};ve.dm.MWBlockImageNode.static.toDataElement=function(domElements,converter){var dataElement,newDimensions,attributes,figure,imgWrapper,img,captionNode,caption,classAttr,typeofAttrs,errorIndex,width,height,href,targetData,types,mwDataJSON,mwData;figure=domElements[0];imgWrapper=figure.children[0];img=imgWrapper.children[0];captionNode=figure.children[1];classAttr=figure.getAttribute('class');typeofAttrs=figure.getAttribute('typeof').trim().split(/\s+/);mwDataJSON=figure.getAttribute
('data-mw');mwData=mwDataJSON?JSON.parse(mwDataJSON):{};errorIndex=typeofAttrs.indexOf('mw:Error');width=img.getAttribute('width');height=img.getAttribute('height');href=imgWrapper.getAttribute('href');if(href){targetData=mw.libs.ve.getTargetDataFromHref(href,converter.getTargetHtmlDocument());if(targetData.isInternal){href='./'+targetData.rawTitle;}}if(errorIndex!==-1){typeofAttrs.splice(errorIndex,1);}types=this.rdfaToTypes[typeofAttrs[0]];attributes={mediaClass:types.mediaClass,type:types.frameType,src:img.getAttribute('src')||img.getAttribute('poster'),href:href,resource:img.getAttribute('resource'),width:width!==null&&width!==''?+width:null,height:height!==null&&height!==''?+height:null,alt:img.getAttribute('alt'),mw:mwData,isError:errorIndex!==-1};this.setClassAttributes(attributes,classAttr);attributes.align=attributes.align||'default';if(attributes.defaultSize){if(attributes.type==='thumb'||attributes.type==='frameless'){attributes.originalWidth=attributes.width;attributes.
originalHeight=attributes.height;newDimensions=this.scaleToThumbnailSize(attributes);if(newDimensions){attributes.width=newDimensions.width;attributes.height=newDimensions.height;}}}if(captionNode){caption=converter.getDataFromDomClean(captionNode,{type:'mwImageCaption'});}else{caption=[{type:'mwImageCaption'},{type:'paragraph',internal:{generated:'wrapper'}},{type:'/paragraph'},{type:'/mwImageCaption'}];}dataElement={type:this.name,attributes:attributes};this.storeGeneratedContents(dataElement,dataElement.attributes.src,converter.getStore());return[dataElement].concat(caption).concat({type:'/'+this.name});};ve.dm.MWBlockImageNode.static.toDomElements=function(data,doc,converter){var width,height,srcAttr,dataElement=data[0],mediaClass=dataElement.attributes.mediaClass,figure=doc.createElement('figure'),imgWrapper=doc.createElement(dataElement.attributes.href?'a':'span'),img=doc.createElement(dataElement.attributes.isError?'span':this.typesToTags[mediaClass]),wrapper=doc.createElement(
'div'),classAttr=this.getClassAttrFromAttributes(dataElement.attributes),captionData=data.slice(1,-1);figure.setAttribute('typeof',this.getRdfa(mediaClass,dataElement.attributes.type));if(!ve.isEmptyObject(dataElement.attributes.mw)){figure.setAttribute('data-mw',JSON.stringify(dataElement.attributes.mw));}if(classAttr){figure.className=classAttr;}if(dataElement.attributes.href){imgWrapper.setAttribute('href',dataElement.attributes.href);}width=dataElement.attributes.width;height=dataElement.attributes.height;if(dataElement.attributes.defaultSize){if(dataElement.attributes.originalWidth!==undefined){width=dataElement.attributes.originalWidth;}if(dataElement.attributes.originalHeight!==undefined){height=dataElement.attributes.originalHeight;}}srcAttr=this.typesToSrcAttrs[mediaClass];if(srcAttr&&!dataElement.attributes.isError){img.setAttribute(srcAttr,dataElement.attributes.src);}img.setAttribute('width',width);img.setAttribute('height',height);img.setAttribute('resource',dataElement.
attributes.resource);if(typeof dataElement.attributes.alt==='string'){img.setAttribute('alt',dataElement.attributes.alt);}figure.appendChild(imgWrapper);imgWrapper.appendChild(img);if(captionData.length>2){converter.getDomSubtreeFromData(data.slice(1,-1),wrapper);while(wrapper.firstChild){figure.appendChild(wrapper.firstChild);}}return[figure];};ve.dm.MWBlockImageNode.prototype.getCaptionNode=function(){var node=this.children[0];return node instanceof ve.dm.MWImageCaptionNode?node:null;};ve.dm.MWBlockImageNode.prototype.suppressSlugType=function(){var align=this.getAttribute('align');return align!=='none'&&align!=='center'?'float':null;};ve.dm.modelRegistry.unregister(ve.dm.BlockImageNode);ve.dm.modelRegistry.register(ve.dm.MWBlockImageNode);ve.dm.MWImageCaptionNode=function VeDmMWImageCaptionNode(){ve.dm.MWImageCaptionNode.super.apply(this,arguments);};OO.inheritClass(ve.dm.MWImageCaptionNode,ve.dm.BranchNode);ve.dm.MWImageCaptionNode.static.name='mwImageCaption';ve.dm.
MWImageCaptionNode.static.matchTagNames=[];ve.dm.MWImageCaptionNode.static.parentNodeTypes=['mwBlockImage'];ve.dm.MWImageCaptionNode.static.toDomElements=function(dataElement,doc){return[doc.createElement('figcaption')];};ve.dm.modelRegistry.register(ve.dm.MWImageCaptionNode);ve.ce.MWResizableNode=function VeCeMWResizableNode($resizable,config){ve.ce.ResizableNode.call(this,$resizable,config);};OO.inheritClass(ve.ce.MWResizableNode,ve.ce.ResizableNode);ve.ce.MWResizableNode.prototype.getAttributeChanges=function(width,height){var attrChanges=ve.ce.ResizableNode.prototype.getAttributeChanges.call(this,width,height);if(!ve.isEmptyObject(attrChanges)){attrChanges.defaultSize=!1;}if(this.getModel().getAttribute('type')==='frame'){attrChanges.type='thumb';}return attrChanges;};ve.ce.MWImageNode=function VeCeMWImageNode($focusable,$image,config){config=ve.extendObject({enforceMax:!1,minDimensions:{width:1,height:1},$bounding:this.$element},config);this.$image=$image;this.
renderedDimensions=null;ve.ce.GeneratedContentNode.call(this);ve.ce.FocusableNode.call(this,$focusable,config);ve.ce.MWResizableNode.call(this,this.$image,config);this.model.connect(this,{attributeChange:'onAttributeChange'});this.updateMediaType();};OO.inheritClass(ve.ce.MWImageNode,ve.ce.GeneratedContentNode);OO.mixinClass(ve.ce.MWImageNode,ve.ce.FocusableNode);OO.mixinClass(ve.ce.MWImageNode,ve.ce.ResizableNode);OO.mixinClass(ve.ce.MWImageNode,ve.ce.MWResizableNode);ve.ce.MWImageNode.static.primaryCommandName='media';ve.ce.MWImageNode.static.getDescription=function(model){var title=new mw.Title(model.getFilename());return title.getMainText();};ve.ce.MWImageNode.prototype.onAttributeChange=function(){this.update();};ve.ce.MWImageNode.prototype.onGeneratedContentNodeUpdate=function(){};ve.ce.MWImageNode.prototype.generateContents=function(){var xhr,params,model=this.getModel(),width=model.getAttribute('width'),height=model.getAttribute('height'),mwData=model.getAttribute('mw')||{},
deferred=ve.createDeferred();if(this.renderedDimensions&&this.renderedDimensions.width>width){return deferred.reject().promise();}if(mwData.thumbtime!==undefined){params='seek='+mwData.thumbtime;}else if(mwData.page!==undefined){params='page'+mwData.page+'-'+width+'px';width=undefined;}xhr=ve.init.target.getContentApi(this.getModel().getDocument()).get({action:'query',prop:'imageinfo',iiprop:'url',iiurlwidth:width,iiurlheight:height,iiurlparam:params,titles:this.getModel().getFilename()}).done(this.onParseSuccess.bind(this,deferred)).fail(this.onParseError.bind(this,deferred));return deferred.promise({abort:xhr.abort});};ve.ce.MWImageNode.prototype.onParseSuccess=function(deferred,response){var thumburl=ve.getProp(response.query.pages[0],'imageinfo',0,'thumburl');if(thumburl){deferred.resolve(thumburl);}else{deferred.reject();}};ve.ce.MWImageNode.prototype.render=function(generatedContents){this.$image.attr('src',generatedContents);this.renderedDimensions=ve.copy(this.model.getScalable
().getCurrentDimensions());if(this.live){this.afterRender();}};ve.ce.MWImageNode.prototype.onParseError=function(deferred){deferred.reject();};ve.ce.MWImageNode.prototype.updateMediaType=function(){if(this.model.getMediaType()==='AUDIO'){this.$image.addClass('ve-ce-mwImageNode-audioPlayer');}else{this.$image.removeClass('ve-ce-mwImageNode-audioPlayer');}};ve.ce.MWInlineImageNode=function VeCeMWInlineImageNode(model,config){var $image;if(model.getAttribute('isError')){this.$element=$('<a>').addClass('new').text(model.getFilename());$image=$([]);}else{if(model.getAttribute('href')){this.$element=$('<a>').addClass('image');$image=$('<img>').appendTo(this.$element);}else{this.$element=$image=$('<img>');}}ve.ce.MWInlineImageNode.super.call(this,model,ve.extendObject({},config,{$element:this.$element}));ve.ce.MWImageNode.call(this,this.$element,$image);$image.attr('src',this.getResolvedAttribute('src')).attr('width',this.model.getAttribute('width')).attr('height',this.model.getAttribute(
'height'));this.showHandles([this.$element.css('direction')==='rtl'?'sw':'se']);this.updateClasses();this.$element.addClass('ve-ce-mwInlineImageNode');};OO.inheritClass(ve.ce.MWInlineImageNode,ve.ce.LeafNode);OO.mixinClass(ve.ce.MWInlineImageNode,ve.ce.GeneratedContentNode);OO.mixinClass(ve.ce.MWInlineImageNode,ve.ce.MWImageNode);ve.ce.MWInlineImageNode.static.name='mwInlineImage';ve.ce.MWInlineImageNode.prototype.updateClasses=function(){var valign=this.model.getAttribute('valign');this.$element.toggleClass('mw-image-border',!!this.model.getAttribute('borderImage'));this.$element.toggleClass('mw-default-size',!!this.model.getAttribute('defaultSize'));if(valign!=='default'){this.$image.css('vertical-align',valign);}};ve.ce.MWInlineImageNode.prototype.onAttributeChange=function(key,from,to){ve.ce.MWImageNode.prototype.onAttributeChange.apply(this,arguments);if(key==='height'||key==='width'){to=parseInt(to,10);}if(from!==to){switch(key){case'width':this.$image.css('width',to);break;case
'height':this.$image.css('height',to);break;case'mediaType':this.updateMediaType();break;}this.updateClasses();}};ve.ce.nodeFactory.register(ve.ce.MWInlineImageNode);ve.ce.MWBlockImageNode=function VeCeMWBlockImageNode(){var type,isError,$image,$missingImage,$focusable;ve.ce.MWBlockImageNode.super.apply(this,arguments);type=this.model.getAttribute('type');isError=this.model.getAttribute('isError');if(isError){$image=$([]);$missingImage=$('<span>').text(this.model.getFilename());this.$a=$('<a>').addClass('new').append($missingImage);$focusable=$missingImage;}else{$image=$('<img>').attr('src',this.getResolvedAttribute('src'));this.$a=$('<a>').addClass('image').attr('href',this.getResolvedAttribute('href')).append($image);$focusable=$image;}this.$element.prepend(this.$a).addClass('ve-ce-mwBlockImageNode ve-ce-mwBlockImageNode-type-'+type).attr('typeof',this.model.getRdfa());ve.ce.MWImageNode.call(this,$focusable,$image);this.updateSize();};OO.inheritClass(ve.ce.MWBlockImageNode,ve.ce.
BranchNode);OO.mixinClass(ve.ce.MWBlockImageNode,ve.ce.GeneratedContentNode);OO.mixinClass(ve.ce.MWBlockImageNode,ve.ce.MWImageNode);ve.ce.MWBlockImageNode.static.name='mwBlockImage';ve.ce.MWBlockImageNode.static.tagName='figure';ve.ce.MWBlockImageNode.static.renderHtmlAttributes=!1;ve.ce.MWBlockImageNode.static.transition=!1;ve.ce.MWBlockImageNode.static.cssClasses={default:{left:'mw-halign-left',right:'mw-halign-right',center:'mw-halign-center',none:'mw-halign-none'},none:{left:'mw-halign-left',right:'mw-halign-right',center:'mw-halign-center',none:'mw-halign-none'}};ve.ce.MWBlockImageNode.prototype.updateClasses=function(oldAlign){var alignClass,align=this.model.getAttribute('align'),type=this.model.getAttribute('type');if(oldAlign&&oldAlign!==align){this.$element.removeClass(this.getCssClass('none',oldAlign)).removeClass(this.getCssClass('default',oldAlign));}if(type!=='none'&&type!=='frameless'){alignClass=this.getCssClass('default',align);this.$image.addClass(
've-ce-mwBlockImageNode-thumbimage');}else{alignClass=this.getCssClass('none',align);this.$image.removeClass('ve-ce-mwBlockImageNode-thumbimage');}this.$element.addClass(alignClass);this.$element.toggleClass('mw-image-border',!!this.model.getAttribute('borderImage'));this.showHandles({'mw-halign-right':['sw'],'mw-halign-left':['se'],'mw-halign-center':['sw','se']}[alignClass]);};ve.ce.MWBlockImageNode.prototype.updateSize=function(dimensions){var isError=this.model.getAttribute('isError'),type=this.model.getAttribute('type'),borderImage=this.model.getAttribute('borderImage'),hasBorderOrFrame=(type!=='none'&&type!=='frameless')||borderImage;if(isError){this.$element.css({width:'',height:''});return;}if(!dimensions){dimensions={width:this.model.getAttribute('width'),height:this.model.getAttribute('height')};}this.$image.css(dimensions);this.$element.css({width:dimensions.width+(hasBorderOrFrame?2:0),height:hasBorderOrFrame?'auto':dimensions.height});this.$element.toggleClass(
'mw-default-size',!!this.model.getAttribute('defaultSize'));};ve.ce.MWBlockImageNode.prototype.getCssClass=function(type,alignment){if(type==='default'&&alignment==='default'){if(this.getModel().getDocument().getDir()==='rtl'){return'mw-halign-left';}else{return'mw-halign-right';}}else{return this.constructor.static.cssClasses[type][alignment];}};ve.ce.MWBlockImageNode.prototype.onSetup=function(){ve.ce.MWBlockImageNode.super.prototype.onSetup.call(this);this.updateClasses();};ve.ce.MWBlockImageNode.prototype.onAttributeChange=function(key,from,to){ve.ce.MWImageNode.prototype.onAttributeChange.apply(this,arguments);if(key==='height'||key==='width'){to=parseInt(to,10);}if(from!==to){switch(key){case'align':this.updateClasses(from);break;case'src':this.$image.attr('src',this.getResolvedAttribute('src'));break;case'width':this.updateSize({width:to,height:this.model.getAttribute('height')});break;case'height':this.updateSize({width:this.model.getAttribute('width'),height:to});break;case
'type':this.$element.removeClass('ve-ce-mwBlockImageNode-type-'+from).addClass('ve-ce-mwBlockImageNode-type-'+to).attr('typeof',this.model.getRdfa());this.updateClasses();this.updateSize();break;case'borderImage':this.updateClasses();this.updateSize();break;case'alt':if(!to){this.$image.removeAttr(key);}else{this.$image.attr(key,to);}break;case'mediaType':this.updateMediaType();break;case'defaultSize':this.$element.toggleClass('mw-default-size',to);break;}}};ve.ce.MWBlockImageNode.prototype.onResizableResizing=function(dimensions){if(!this.outline){ve.ce.ResizableNode.prototype.onResizableResizing.call(this,dimensions);this.updateSize(dimensions);}};ve.ce.MWBlockImageNode.prototype.getDomPosition=function(){var domNode=this.$element.last()[0];return{node:domNode,offset:domNode.childNodes.length};};ve.ce.nodeFactory.register(ve.ce.MWBlockImageNode);ve.ce.MWImageCaptionNode=function VeCeMWImageCaptionNode(){ve.ce.MWImageCaptionNode.super.apply(this,arguments);ve.ce.ActiveNode.call(this);
};OO.inheritClass(ve.ce.MWImageCaptionNode,ve.ce.BranchNode);OO.mixinClass(ve.ce.MWImageCaptionNode,ve.ce.ActiveNode);ve.ce.MWImageCaptionNode.static.name='mwImageCaption';ve.ce.MWImageCaptionNode.static.tagName='figcaption';ve.ce.nodeFactory.register(ve.ce.MWImageCaptionNode);},{"css":[".ve-ce-mwImageNode-audioPlayer{ background:#fff url(/w/extensions/VisualEditor/modules/ve-mw/ce/styles/nodes/images/audioPlayer.svg?42040) !important;  height:0 !important;padding-top:32px}  .ve-ce-mwBlockImageNode \u003E figcaption p{margin:0 !important; } .ve-ce-mwBlockImageNode \u003E a:after{pointer-events:none} .ve-ce-mwInlineImageNode{display:inline-block}"]});